# CVE-2019-1388 Windows UAC 提权漏洞

## 简介
该漏洞发生在非管理员使用需要以管理员身份启动的软件时，出现的UAC（User Access Controller）提示，该提示是由进程Consent.exe提供，在`CVE-2019-1388`漏洞中，利用了UAC中的证书对话框得以实现。


## 影响范围
```
Windows 2008r2		
Windows 2012r2		
Windows 2016		
Windows 7 SP1		
Windows 8			
Windows 8.1			
Windows 10 	（低版本）
```
## 漏洞补丁：
```
KB4525235
KB4525233
```
## 漏洞详情

以 `Windows Server 2008 R2` 为例
创建本地用户组成员`user`，如下

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-01.png)


对于UAC自Windows Vista开始就是微软加入到系统中的一个权限控制机制，即通知客户是否启用某些文件或者程序

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-02.png)
正常情况下，我们申请UAC的过程中，点击`显示有关此发布者的证书的信息` 会出现相关软件的发布者证书，而研究者发现在大量的证书显示过程中，都是没有可利用的链接，换句话说出了是/否/确定，好像没有其他能够提升权限的地方。

这次的漏洞主要还是出现在证书当中，在个别办法这的证书信息中，找到了突破口，研究者发现一个非常古老的带Windows证书的程序，以至于我们可以利用它来进行权限提升，接下来是操作

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-03.png)
首先该程序的名字为`HHUPD.exe` 是微软的一个程序，其证书信息如上

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-04.png)

以管理员权限打开，出现UAC提示界面，点击 `显示有关此发布者的证书的信息` ，出现该软件的证书详情，可以看到这里`颁发者`以超链接的形式出现，我们点击试试。

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-08.png)
这里解释一下证书对话框出现的超链接：
微软定义了一个模糊的概念， 特定对象标识符（OID），其具有数值1.3.6.1.4.1.311.2.1.10。而WinTrust.h 头文件中将其定义为SPC_SP_AGENCY_INFO_OBJID。官方文档中关于`SPC_SP_AGENCY_INFO_OBJID`比较少，但是我们可以看到在格式正确的情况下，可以在颁发者中显示超链接，也可能是微软没有禁用掉该超链接的原因




![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-05.png)
点击完成之后，然后点击 证书界面的 `确定` 按钮，UAC界面的 `否(N)` 按钮，发现出现了`Internet Explorer `


要知道 浏览器 是可以打开文件的，开始试验一下

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-06.png)

依次顺序是
```
浏览器-菜单栏-文件-打开..-浏览-路径(C:\windows\system32)-文件类型(所有文件)-cmd.exe(右键以管理员身份运行)
```

![](https://raw.githubusercontent.com/is0late/is0late.github.io/master/_posts/2019/media/2019-12-09-13-41-07.png)

至此，普通用户的提权梦得以实现。
同时也可以知道，超链接是以consent.exe的系统管理员权限启动的

## 后记

虽然说本地用户的提权对于现有的Windows计算机可以达到大范围的通杀，但是在渗透过程中，往往会以远程登陆的形式进行渗透，甚至多是命令行下的。所以该提权漏洞的实际利用就是仁者见仁，智者见智了。而微软官方的漏洞补丁信息显示为不太可能被利用，祝大家好运。
